<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ГРОРХИД — Мини-приложение</title>

  <!-- Telegram Mini App SDK -->
  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <style>
    :root{
      --bg:#0f1115;
      --card:#171a22;
      --card2:#1d2130;
      --text:#e8eaed;
      --muted:#aeb4c0;
      --line:#2a2f3c;
      --accent:#4bd4a7;
      --accent2:#5aa7ff;
      --warn:#ffcc66;
      --danger:#ff6b6b;
      --radius:18px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: -apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial,Helvetica,sans-serif;
      background: linear-gradient(180deg,#0b0d12 0%, #101320 100%);
      color:var(--text);
    }
    .wrap{
      max-width: 980px;
      margin:0 auto;
      padding: 14px 14px 28px;
    }
    .topbar{
      display:flex;
      gap:10px;
      align-items:center;
      justify-content:space-between;
      margin-bottom: 12px;
    }
    .brand{
      display:flex;
      flex-direction:column;
      gap:2px;
    }
    .brand .title{
      font-weight:800;
      letter-spacing:.4px;
      font-size:18px;
      line-height:1.1;
    }
    .brand .sub{
      font-size:12px;
      color:var(--muted);
    }

    .right{
      display:flex;
      gap:10px;
      align-items:center;
    }
    .pill{
      padding:8px 10px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.03);
      border-radius: 999px;
      font-size:12px;
      color: var(--muted);
      cursor:pointer;
      user-select:none;
      display:flex;
      align-items:center;
      gap:8px;
    }
    .pill strong{ color: var(--text); font-weight:700; }
    .tabs{
      display:flex;
      gap:8px;
      margin: 8px 0 10px;
    }
    .tab{
      flex:0 0 auto;
      padding:10px 12px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.02);
      border-radius: 999px;
      font-size:13px;
      color: var(--muted);
      cursor:pointer;
      user-select:none;
    }
    .tab.active{
      background: rgba(75,212,167,.10);
      border-color: rgba(75,212,167,.35);
      color: var(--text);
    }

    .search{
      display:flex;
      gap:10px;
      align-items:center;
      padding: 10px 12px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.02);
      border-radius: var(--radius);
      margin-bottom: 12px;
    }
    .search input{
      width:100%;
      border:0;
      outline:0;
      background: transparent;
      color: var(--text);
      font-size:14px;
    }
    .search input::placeholder{ color:#7f8797; }
    .hint{
      font-size:12px;
      color: var(--muted);
      margin: 0 0 12px;
      line-height: 1.35;
    }

    .grid{
      display:grid;
      grid-template-columns: repeat(2, minmax(0,1fr));
      gap: 12px;
    }
    @media (min-width: 760px){
      .grid{ grid-template-columns: repeat(3, minmax(0,1fr)); }
    }

    .card{
      border:1px solid var(--line);
      background: linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.02));
      border-radius: var(--radius);
      overflow:hidden;
      display:flex;
      flex-direction:column;
      min-height: 180px;
    }
    .thumb{
      height: 86px;
      background: radial-gradient(120px 80px at 20% 30%, rgba(75,212,167,.18), rgba(0,0,0,0) 70%),
                  radial-gradient(120px 80px at 80% 70%, rgba(90,167,255,.20), rgba(0,0,0,0) 70%),
                  linear-gradient(180deg, rgba(255,255,255,.02), rgba(0,0,0,0));
      position:relative;
      padding: 10px 10px 0;
    }
    .tagrow{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
    }
    .tag{
      font-size:11px;
      color: var(--muted);
      padding: 6px 8px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.08);
      background: rgba(0,0,0,.16);
      backdrop-filter: blur(6px);
    }

    .content{
      padding: 10px 10px 12px;
      display:flex;
      flex-direction:column;
      gap:10px;
      flex:1;
    }
    .name .ru{ font-weight:800; font-size:14px; }
    .name .lat{ color: var(--muted); font-size:12px; margin-top:2px; line-height:1.25; }

    .mini{
      color: var(--muted);
      font-size:12px;
      line-height:1.35;
      flex:1;
    }
    .actions{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
    }
    .btn{
      border:1px solid var(--line);
      background: rgba(255,255,255,.03);
      color: var(--text);
      padding: 10px 10px;
      border-radius: 12px;
      font-size:13px;
      cursor:pointer;
      user-select:none;
    }
    .btn.primary{
      border-color: rgba(75,212,167,.45);
      background: rgba(75,212,167,.12);
    }
    .btn.wb{
      border-color: rgba(90,167,255,.40);
      background: rgba(90,167,255,.10);
    }
    .btn.danger{
      border-color: rgba(255,107,107,.45);
      background: rgba(255,107,107,.10);
    }
    .btn:active{ transform: translateY(1px); }

    /* Modal */
    .overlay{
      position:fixed; inset:0;
      background: rgba(0,0,0,.60);
      display:none;
      align-items:flex-end;
      justify-content:center;
      padding: 12px;
      z-index: 9999;
    }
    .overlay.show{ display:flex; }
    .modal{
      width:100%;
      max-width: 720px;
      border:1px solid var(--line);
      background: linear-gradient(180deg, rgba(23,26,34,.98), rgba(19,22,30,.98));
      border-radius: 22px;
      overflow:hidden;
      box-shadow: 0 12px 40px rgba(0,0,0,.55);
    }
    .modalHead{
      padding: 14px 14px 10px;
      border-bottom: 1px solid rgba(255,255,255,.06);
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:10px;
    }
    .modalTitle{
      font-size:16px;
      font-weight:900;
      line-height:1.2;
    }
    .modalClose{
      width:38px; height:38px;
      display:flex; align-items:center; justify-content:center;
      border-radius: 12px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.04);
      cursor:pointer;
      user-select:none;
    }
    .modalBody{
      padding: 12px 14px 14px;
      display:grid;
      gap:12px;
    }
    .block{
      border:1px solid rgba(255,255,255,.07);
      background: rgba(255,255,255,.02);
      border-radius: 16px;
      padding: 12px;
    }
    .block h3{
      margin:0 0 8px;
      font-size:13px;
      color: var(--muted);
      font-weight:800;
      letter-spacing:.2px;
      text-transform: uppercase;
    }
    .block p{
      margin:0;
      font-size:13px;
      line-height:1.45;
      color: var(--text);
    }
    .list{
      margin:0;
      padding-left: 16px;
      color: var(--text);
      font-size:13px;
      line-height:1.45;
    }
    .list li{ margin: 6px 0; }
    .row{
      display:flex; gap:10px; flex-wrap:wrap;
      margin-top: 10px;
    }

    /* Cart drawer */
    .cartDrawer{
      position: fixed;
      right: 12px; bottom: 12px;
      width: min(420px, calc(100% - 24px));
      border:1px solid var(--line);
      background: rgba(23,26,34,.96);
      border-radius: 18px;
      overflow:hidden;
      display:none;
      z-index: 9998;
    }
    .cartDrawer.show{ display:block; }
    .cartHead{
      padding: 12px 12px 10px;
      display:flex;
      justify-content:space-between;
      align-items:center;
      border-bottom: 1px solid rgba(255,255,255,.06);
    }
    .cartHead .t{
      font-weight:900;
      font-size:14px;
    }
    .cartBody{
      max-height: 46vh;
      overflow:auto;
      padding: 10px 12px;
      display:grid;
      gap:10px;
    }
    .cartItem{
      border:1px solid rgba(255,255,255,.07);
      background: rgba(255,255,255,.02);
      border-radius: 14px;
      padding: 10px;
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      gap:10px;
    }
    .cartItem .n{ font-weight:800; font-size:13px; }
    .cartItem .m{ color: var(--muted); font-size:12px; margin-top:2px; line-height:1.25; }
    .cartItem a{ color: var(--accent2); text-decoration:none; font-size:12px; }
    .cartFoot{
      padding: 12px;
      border-top: 1px solid rgba(255,255,255,.06);
      display:flex;
      gap:8px;
      flex-wrap:wrap;
    }

    .empty{
      padding: 20px 0;
      color: var(--muted);
      font-size: 13px;
      text-align:center;
    }
    .badge{
      padding: 4px 8px;
      border-radius: 999px;
      font-size: 11px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.18);
      color: var(--muted);
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="topbar">
      <div class="brand">
        <div class="title">ГРОРХИД</div>
        <div class="sub">Уход • Пересадка • Каталог грунтов WB/Ozon • Поддержка</div>
      </div>

      <div class="right">
        <div class="pill" id="openSupportPill">Поддержка <strong>@melnikovnikitaa</strong></div>
        <div class="pill" id="openCartPill">Корзина <span class="badge" id="cartCount">0</span></div>
      </div>
    </div>

    <div class="tabs">
      <div id="tabPlants" class="tab active">Растения</div>
      <div id="tabWB" class="tab">WB</div>
      <div id="tabOZ" class="tab">Ozon</div>
    </div>

    <div class="search">
      <input id="q" type="text" placeholder="Поиск: растение / грунт / объём (например: орхидея 2л, замиокулькас, кора)" />
    </div>

    <div class="hint" id="hint">
      Открывай карточку растения — внутри уход, полив, пересадка, видео и рекомендуемые товары. Во вкладках WB/Ozon — полный каталог.
    </div>

    <div class="grid" id="grid"></div>

  </div>

  <!-- Modal -->
  <div class="overlay" id="overlay">
    <div class="modal">
      <div class="modalHead">
        <div>
          <div class="modalTitle" id="mTitle">Растение</div>
          <div class="sub" id="mSubtitle" style="margin-top:4px;color:var(--muted);font-size:12px;"></div>
        </div>
        <div class="modalClose" id="mClose">✕</div>
      </div>
      <div class="modalBody" id="mBody">
        <!-- blocks injected -->
      </div>
      <div style="padding: 0 14px 14px;">
        <div class="row">
          <button class="btn wb" id="mOpenProduct">Открыть товар</button>
          <button class="btn primary" id="mAddPrimary">В корзину</button>
          <button class="btn" id="mSupport">Написать в поддержку</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Cart drawer -->
  <div class="cartDrawer" id="cartDrawer">
    <div class="cartHead">
      <div class="t">Корзина</div>
      <div class="pill" id="closeCartPill">Закрыть</div>
    </div>
    <div class="cartBody" id="cartBody"></div>
    <div class="cartFoot">
      <button class="btn wb" id="openAllLinks">Открыть товары</button>
      <button class="btn" id="sendToSupport">Отправить список в поддержку</button>
      <button class="btn danger" id="clearCart">Очистить</button>
    </div>
  </div>

<script>
  // Telegram init
  const tg = window.Telegram?.WebApp;
  if(tg){
    tg.ready();
    tg.expand();
  }

  // --- Helpers ---
  const esc = (s)=> String(s ?? "").replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
  function openLink(url){
    if(!url) return;
    if(tg?.openLink) tg.openLink(url);
    else window.open(url, "_blank");
  }
  function openTgUser(username){
    const url = "https://t.me/" + String(username).replace("@","");
    openLink(url);
  }

  // --- Data: Products ---
  const products = [
    // WB: Orchid soils
    { id:"wb_orch_soil_1l", name:"Грунт для орхидей 1л", volume:"1л", plant:"Орхидея (фаленопсис)", mp:"WB", url:"https://www.wildberries.ru/catalog/242662173/detail.aspx" },
    { id:"wb_orch_soil_2l", name:"Грунт для орхидей 2л", volume:"2л", plant:"Орхидея (фаленопсис)", mp:"WB", url:"https://www.wildberries.ru/catalog/230055721/detail.aspx?targetUrl=GP" },
    { id:"wb_orch_soil_3l", name:"Грунт для орхидей 3л", volume:"3л", plant:"Орхидея (фаленопсис)", mp:"WB", url:"https://www.wildberries.ru/catalog/321372762/detail.aspx?targetUrl=GP" },
    { id:"wb_orch_soil_5l", name:"Грунт для орхидей 5л", volume:"5л", plant:"Орхидея (фаленопсис)", mp:"WB", url:"https://www.wildberries.ru/catalog/340068487/detail.aspx?targetUrl=GP" },

    // WB: Other soils
    { id:"wb_zami_soil_3l", name:"Грунт для замиокулькаса 3л", volume:"3л", plant:"Замиокулькас", mp:"WB", url:"https://www.wildberries.ru/catalog/321383073/detail.aspx" },
    { id:"wb_zami_soil_5l", name:"Грунт для замиокулькаса 5л", volume:"5л", plant:"Замиокулькас", mp:"WB", url:"https://www.wildberries.ru/catalog/327492373/detail.aspx?targetUrl=GP" },

    { id:"wb_spath_soil_3l", name:"Грунт для спатифиллума 3л", volume:"3л", plant:"Спатифиллум", mp:"WB", url:"https://www.wildberries.ru/catalog/591266116/detail.aspx?targetUrl=EX" },
    { id:"wb_spath_soil_5l", name:"Грунт для спатифиллума 5л", volume:"5л", plant:"Спатифиллум", mp:"WB", url:"https://www.wildberries.ru/catalog/450413475/detail.aspx?targetUrl=GP" },

    { id:"wb_ficus_soil_5l", name:"Грунт для фикуса и пальм 5л", volume:"5л", plant:"Фикус/Пальмы", mp:"WB", url:"https://www.wildberries.ru/catalog/447870726/detail.aspx?targetUrl=GP" },
    { id:"wb_monst_soil_5l", name:"Грунт для монстеры 5л", volume:"5л", plant:"Монстера", mp:"WB", url:"https://www.wildberries.ru/catalog/434106528/detail.aspx?targetUrl=GP" },
    { id:"wb_aroid_soil_5l", name:"Грунт для ароидных 5л", volume:"5л", plant:"Ароидные (антуриум/монстера и др.)", mp:"WB", url:"https://www.wildberries.ru/catalog/432265446/detail.aspx?targetUrl=GP" },

    // WB: Extras
    { id:"wb_leca_5l", name:"Дренаж керамзитовый 5л", volume:"5л", plant:"Универсально", mp:"WB", url:"https://www.wildberries.ru/catalog/278148308/detail.aspx" },
    { id:"wb_orch_bark_2l", name:"Кора для орхидей 2л", volume:"2л", plant:"Орхидея (фаленопсис)", mp:"WB", url:"https://www.wildberries.ru/catalog/365230106/detail.aspx" },
    { id:"wb_orch_bark_5l", name:"Кора для орхидей 5л", volume:"5л", plant:"Орхидея (фаленопсис)", mp:"WB", url:"https://www.wildberries.ru/catalog/365245989/detail.aspx" },
    { id:"wb_mulch_bark_5l", name:"Кора для мульчирования 5л", volume:"5л", plant:"Сад/комнатные", mp:"WB", url:"https://www.wildberries.ru/catalog/265569113/detail.aspx" },

    // OZON
    { id:"oz_orch_soil_2l", name:"Грунт для орхидей 2л", volume:"2л", plant:"Орхидея (фаленопсис)", mp:"OZON", url:"https://www.ozon.ru/product/grunt-dlya-orhidey-1581895369/?at=QktJjA0g7cLnQ6m3IQ0lO3QtLwx3V1UVGrEYkHWY9knO" },
    { id:"oz_orch_soil_3l", name:"Грунт для орхидей 3л", volume:"3л", plant:"Орхидея (фаленопсис)", mp:"OZON", url:"https://www.ozon.ru/product/grunt-dlya-orhidey-3l-1655185529/?at=QktJjA0g7cLnQ6m3IQ0lO3QtLwx3V1UVGrEYkHWY9knO&from_sku=1581895369&oos_search=false" },
    { id:"oz_orch_soil_5l", name:"Грунт для орхидей 5л", volume:"5л", plant:"Орхидея (фаленопсис)", mp:"OZON", url:"https://www.ozon.ru/product/grunt-dlya-orhidey-substrat-5l-1971223869/?at=QktJjA0g7cLnQ6m3IQ0lO3QtLwx3V1UVGrEYkHWY9knO&from_sku=1581895369&oos_search=false" },

    { id:"oz_zami_soil_5l", name:"Грунт для замиокулькаса 5л", volume:"5л", plant:"Замиокулькас", mp:"OZON", url:"https://www.ozon.ru/product/grunt-dlya-zamiokulkasa-5l-2209951547/?_bctx=CAQQhoB8&hs=1" },
    { id:"oz_spath_soil_5l", name:"Грунт для спатифиллума 5л", volume:"5л", plant:"Спатифиллум", mp:"OZON", url:"https://www.ozon.ru/product/grunt-dlya-spatifilluma-5l-2361594678/?from_sku=2209951547&oos_search=false" },
    { id:"oz_aroid_soil_5l", name:"Грунт для ароидных 5л", volume:"5л", plant:"Ароидные", mp:"OZON", url:"https://www.ozon.ru/product/grunt-dlya-zamiokulkasa-spatifilluma-anturiuma-monstery-2361164827/?from_sku=2209951547&oos_search=false" },

    { id:"oz_dekab_soil_5l", name:"Грунт для декабриста 5л", volume:"5л", plant:"Декабрист", mp:"OZON", url:"https://www.ozon.ru/product/grunt-dlya-dekabrista-5l-3260866085/?from_sku=2209951547&oos_search=false" },
    { id:"oz_citrus_soil_5l", name:"Грунт для цитрусовых 5л", volume:"5л", plant:"Цитрусовые", mp:"OZON", url:"https://www.ozon.ru/product/grunt-dlya-tsitrusovyh-rasteniy-limona-mandarina-avokado-i-mango-5l-3261099633/?from_sku=2209951547&oos_search=false" },
  ];

  // --- Data: Plants (3 сейчас, легко расширим до 10) ---
  const plants = [
    {
      id:"spath",
      name:"Спатифиллум",
      latin:"Spathiphyllum",
      tags:["уход","полив","пересадка"],
      about:"Тропическое растение из влажных лесов Центральной и Южной Америки. В природе растёт в тени, любит стабильную влажность и тёплый воздух.",
      watering:[
        "Летом: когда подсохнут верхние 2–3 см грунта (обычно 1–2 раза в неделю).",
        "Зимой: реже, по просушке (примерно 1 раз в 7–10 дней).",
        "Вода: мягкая, отстоянная, комнатной температуры."
      ],
      repot:[
        "Пересаживайте каждые 12–18 месяцев, лучше весной.",
        "Горшок +2–3 см к диаметру. Обязательно дренаж 2–3 см.",
        "После пересадки 5–7 дней без подкормок, полив умеренный."
      ],
      notes:[
        "Жёлтые листья часто = перелив или жёсткая вода.",
        "Любит повышенную влажность: опрыскивание/увлажнитель."
      ],
      video:"https://www.youtube.com/results?search_query=пересадка+спатифиллума",
      productIds:["wb_spath_soil_3l","wb_spath_soil_5l","oz_spath_soil_5l"]
    },
    {
      id:"zami",
      name:"Замиокулькас",
      latin:"Zamioculcas zamiifolia",
      tags:["непереливать","суккулентный","пересадка"],
      about:"Родом из Восточной Африки. В природе переносит засуху, растёт в рыхлых субстратах. Главная ошибка дома — перелив.",
      watering:[
        "Поливать только после почти полной просушки (летом раз в 10–14 дней, зимой реже).",
        "Чем прохладнее и темнее — тем реже полив.",
        "Если сомневаетесь — лучше не полить."
      ],
      repot:[
        "Пересадка раз в 18–24 месяца (или если горшок трескается/корни выталкивают).",
        "Нужен очень рыхлый субстрат и дренаж.",
        "После пересадки 7 дней не поливать, затем аккуратно."
      ],
      notes:[
        "Жёлтые мягкие стебли — почти всегда перелив.",
        "Любит яркий рассеянный свет."
      ],
      video:"https://www.youtube.com/results?search_query=пересадка+замиокулькаса",
      productIds:["wb_zami_soil_3l","wb_zami_soil_5l","oz_zami_soil_5l"]
    },
    {
      id:"orch",
      name:"Орхидея (Фаленопсис)",
      latin:"Phalaenopsis",
      tags:["кора","воздух","корни"],
      about:"Эпифит: в природе растёт на деревьях, корни дышат. Ей нужен воздушный субстрат (кора) и правильный режим полива.",
      watering:[
        "Полив после просушки коры: корни стали серебристыми — можно поливать.",
        "Лучше замачивание 10–15 минут и дать полностью стечь.",
        "Не оставлять воду в розетке листьев."
      ],
      repot:[
        "Пересадка каждые 12–18 месяцев или при разложении коры.",
        "Удалите гнилые корни, срезы присыпать углём/корицей.",
        "Первые 3–5 дней без полива, затем аккуратно."
      ],
      notes:[
        "Прозрачный горшок — плюс: видно корни и влагу.",
        "Кора должна быть фракцией, не пылью."
      ],
      video:"https://www.youtube.com/results?search_query=пересадка+фаленопсиса",
      productIds:["wb_orch_soil_1l","wb_orch_soil_2l","wb_orch_soil_3l","wb_orch_soil_5l","wb_orch_bark_2l","wb_orch_bark_5l","wb_leca_5l","oz_orch_soil_2l","oz_orch_soil_3l","oz_orch_soil_5l"]
    },
  ];

  // --- UI refs ---
  const grid = document.getElementById("grid");
  const q = document.getElementById("q");
  const hint = document.getElementById("hint");

  const tabPlants = document.getElementById("tabPlants");
  const tabWB = document.getElementById("tabWB");
  const tabOZ = document.getElementById("tabOZ");

  const overlay = document.getElementById("overlay");
  const mClose = document.getElementById("mClose");
  const mTitle = document.getElementById("mTitle");
  const mSubtitle = document.getElementById("mSubtitle");
  const mBody = document.getElementById("mBody");
  const mOpenProduct = document.getElementById("mOpenProduct");
  const mAddPrimary = document.getElementById("mAddPrimary");
  const mSupport = document.getElementById("mSupport");

  const openSupportPill = document.getElementById("openSupportPill");
  const openCartPill = document.getElementById("openCartPill");
  const cartCount = document.getElementById("cartCount");

  const cartDrawer = document.getElementById("cartDrawer");
  const cartBody = document.getElementById("cartBody");
  const closeCartPill = document.getElementById("closeCartPill");
  const clearCartBtn = document.getElementById("clearCart");
  const openAllLinksBtn = document.getElementById("openAllLinks");
  const sendToSupportBtn = document.getElementById("sendToSupport");

  // --- State ---
  let mode = "plants"; // plants | wb | oz
  let activePrimaryProductId = null;

  // cart: Map productId -> qty
  const cart = new Map();

  // --- Support ---
  const SUPPORT_USERNAME = "@melnikovnikitaa";

  openSupportPill.onclick = ()=> openTgUser(SUPPORT_USERNAME);
  mSupport.onclick = ()=> openTgUser(SUPPORT_USERNAME);

  // --- Tabs ---
  tabPlants.onclick = ()=> setMode("plants");
  tabWB.onclick = ()=> setMode("wb");
  tabOZ.onclick = ()=> setMode("oz");

  function setMode(m){
    mode = m;
    tabPlants.classList.toggle("active", mode==="plants");
    tabWB.classList.toggle("active", mode==="wb");
    tabOZ.classList.toggle("active", mode==="oz");

    if(mode==="plants"){
      hint.textContent = "Открывай карточку растения — внутри уход, полив, пересадка, видео и рекомендуемые товары. Если не нашли ответ — пишите в поддержку.";
    } else if(mode==="wb"){
      hint.textContent = "Каталог Wildberries: добавляйте товары в корзину, открывайте карточки и при необходимости отправляйте список в поддержку.";
    } else {
      hint.textContent = "Каталог Ozon: добавляйте товары в корзину, открывайте карточки и при необходимости отправляйте список в поддержку.";
    }
    renderGrid();
  }

  // --- Search ---
  q.addEventListener("input", renderGrid);

  // --- Grid render ---
  function emptyState(){
    return `<div class="empty">Ничего не найдено. Попробуйте другой запрос.</div>`;
  }

  function renderGrid(){
    const query = (q.value || "").trim().toLowerCase();
    if(mode==="plants"){
      const items = plants.filter(p=>{
        if(!query) return true;
        return (p.name+" "+p.latin+" "+(p.tags||[]).join(" ")).toLowerCase().includes(query);
      });

      grid.innerHTML = items.map(p=>`
        <div class="card" onclick="openPlant('${p.id}')">
          <div class="thumb">
            <div class="tagrow">
              ${(p.tags||[]).slice(0,3).map(t=>`<span class="tag">${esc(t)}</span>`).join("")}
            </div>
          </div>
          <div class="content">
            <div class="name">
              <div class="ru">${esc(p.name)}</div>
              <div class="lat">${esc(p.latin)}</div>
            </div>
            <div class="mini">${esc(p.about)}</div>
            <div class="actions">
              <button class="btn primary" onclick="event.stopPropagation(); openPlant('${p.id}')">Открыть</button>
              <button class="btn" onclick="event.stopPropagation(); openTgUser('${SUPPORT_USERNAME}')">Поддержка</button>
            </div>
          </div>
        </div>
      `).join("") || emptyState();

    } else {
      const mp = (mode==="wb") ? "WB" : "OZON";
      const items = products.filter(x=>{
        if(x.mp !== mp) return false;
        if(!query) return true;
        return (x.name+" "+x.volume+" "+x.plant).toLowerCase().includes(query);
      });

      grid.innerHTML = items.map(pr=>`
        <div class="card">
          <div class="thumb">
            <div class="tagrow">
              <span class="tag">${esc(pr.mp)}</span>
              <span class="tag">${esc(pr.volume)}</span>
            </div>
          </div>
          <div class="content">
            <div class="name">
              <div class="ru">${esc(pr.name)}</div>
              <div class="lat">Для: ${esc(pr.plant)}</div>
            </div>
            <div class="mini">Добавьте в корзину и откройте карточку на ${esc(pr.mp)}. Если нужен подбор — напишите в поддержку.</div>
            <div class="actions">
              <button class="btn wb" onclick="openLink('${pr.url}')">Открыть ${esc(pr.mp)}</button>
              <button class="btn primary" onclick="addProductToCart('${pr.id}')">В корзину</button>
            </div>
          </div>
        </div>
      `).join("") || emptyState();
    }
  }

  // expose for onclick in html
  window.openPlant = (id)=>{
    const p = plants.find(x=>x.id===id);
    if(!p) return;
    showPlantModal(p);
  };

  function showPlantModal(p){
    mTitle.textContent = p.name;
    mSubtitle.textContent = p.latin;

    const rec = (p.productIds||[])
      .map(pid => products.find(x=>x.id===pid))
      .filter(Boolean);

    activePrimaryProductId = rec[0]?.id || null;

    const recHtml = rec.length ? `
      <ul class="list">
        ${rec.slice(0,10).map(r=>`
          <li>
            <strong>${esc(r.name)}</strong> — <span style="color:var(--muted)">${esc(r.mp)} • ${esc(r.volume)}</span>
            <div class="row" style="margin-top:8px">
              <button class="btn wb" onclick="openLink('${r.url}')">Открыть</button>
              <button class="btn primary" onclick="addProductToCart('${r.id}')">В корзину</button>
            </div>
          </li>
        `).join("")}
      </ul>
    ` : `<div class="empty">Пока нет привязанных товаров.</div>`;

    mBody.innerHTML = `
      <div class="block">
        <h3>Как растение растёт в природе</h3>
        <p>${esc(p.about)}</p>
      </div>
      <div class="block">
        <h3>Полив</h3>
        <ul class="list">${(p.watering||[]).map(x=>`<li>${esc(x)}</li>`).join("")}</ul>
      </div>
      <div class="block">
        <h3>Пересадка</h3>
        <ul class="list">${(p.repot||[]).map(x=>`<li>${esc(x)}</li>`).join("")}</ul>
      </div>
      <div class="block">
        <h3>Важные заметки</h3>
        <ul class="list">${(p.notes||[]).map(x=>`<li>${esc(x)}</li>`).join("")}</ul>
      </div>
      <div class="block">
        <h3>Видео по теме</h3>
        <p>
          Откройте подборку видео (YouTube-поиск):<br/>
          <a href="${esc(p.video)}" target="_blank" style="color:var(--accent2);text-decoration:none;">${esc(p.video)}</a>
        </p>
        <div class="row">
          <button class="btn wb" onclick="openLink('${p.video}')">Открыть видео</button>
        </div>
      </div>
      <div class="block">
        <h3>Рекомендуемые товары</h3>
        ${recHtml}
        <p style="margin-top:10px;color:var(--muted);font-size:12px;">
          Если не нашли информацию — напишите в поддержку: ${esc(SUPPORT_USERNAME)}.
        </p>
      </div>
    `;

    // primary buttons
    mOpenProduct.textContent = "Открыть товар";
    mOpenProduct.onclick = ()=>{
      const pp = products.find(x=>x.id===activePrimaryProductId);
      if(pp?.url) openLink(pp.url);
      else openTgUser(SUPPORT_USERNAME);
    };

    mAddPrimary.onclick = ()=>{
      const pp = products.find(x=>x.id===activePrimaryProductId);
      if(pp?.id) addProductToCart(pp.id);
      else alert("Товар не выбран.");
    };

    overlay.classList.add("show");
  }

  mClose.onclick = ()=> overlay.classList.remove("show");
  overlay.addEventListener("click", (e)=>{
    if(e.target === overlay) overlay.classList.remove("show");
  });

  // --- Cart ---
  function addProductToCart(pid){
    const qty = cart.get(pid) || 0;
    cart.set(pid, qty+1);
    updateCartUI(true);
    if(tg?.HapticFeedback) tg.HapticFeedback.impactOccurred("light");
  }
  window.addProductToCart = addProductToCart;

  function removeOne(pid){
    const qty = cart.get(pid) || 0;
    if(qty<=1) cart.delete(pid);
    else cart.set(pid, qty-1);
    updateCartUI(false);
  }

  function updateCartUI(openDrawer){
    let count = 0;
    for(const [,qty] of cart.entries()) count += qty;
    cartCount.textContent = String(count);

    if(openDrawer) cartDrawer.classList.add("show");

    if(cart.size === 0){
      cartBody.innerHTML = `<div class="empty">Корзина пустая. Добавьте товары из каталога WB/Ozon или из карточки растения.</div>`;
      return;
    }

    const lines = [];
    for(const [pid, qty] of cart.entries()){
      const pr = products.find(x=>x.id===pid);
      if(!pr) continue;
      lines.push(`
        <div class="cartItem">
          <div>
            <div class="n">${esc(pr.name)} <span class="badge">×${qty}</span></div>
            <div class="m">${esc(pr.mp)} • ${esc(pr.volume)} • ${esc(pr.plant)}</div>
            <div style="margin-top:6px;">
              <a href="${esc(pr.url)}" target="_blank">Открыть карточку</a>
            </div>
          </div>
          <div class="actions" style="justify-content:flex-end;">
            <button class="btn" onclick="removeOne('${pid}')">−</button>
            <button class="btn primary" onclick="addProductToCart('${pid}')">+</button>
          </div>
        </div>
      `);
    }
    cartBody.innerHTML = lines.join("");
  }
  window.removeOne = removeOne;

  openCartPill.onclick = ()=>{
    cartDrawer.classList.toggle("show");
    updateCartUI(false);
  };
  closeCartPill.onclick = ()=> cartDrawer.classList.remove("show");

  clearCartBtn.onclick = ()=>{
    cart.clear();
    updateCartUI(false);
  };

  openAllLinksBtn.onclick = ()=>{
    if(cart.size===0){ alert("Корзина пустая."); return; }
    for(const [pid] of cart.entries()){
      const p = products.find(x=>x.id===pid);
      if(p?.url) openLink(p.url);
    }
  };

  sendToSupportBtn.onclick = ()=>{
    if(cart.size===0){ openTgUser(SUPPORT_USERNAME); return; }

    const items = [];
    for(const [pid, qty] of cart.entries()){
      const pr = products.find(x=>x.id===pid);
      if(!pr) continue;
      items.push(`• ${pr.name} (${pr.mp}, ${pr.volume}) ×${qty}\n${pr.url}`);
    }
    const text =
      "Здравствуйте! Нужна помощь с подбором/заказом:\n\n" +
      items.join("\n\n") +
      "\n\nСпасибо!";

    // easiest: open support chat; user can paste message
    openTgUser(SUPPORT_USERNAME);
    alert("Открыл поддержку. Скопируй текст списка из буфера (если нужно — скажи, я добавлю кнопку копирования).");
    try{
      navigator.clipboard.writeText(text);
    }catch(e){}
  };

  // initial
  setMode("plants");
  updateCartUI(false);
</script>
</body>
</html>

